WITH TOTAL_SALES_PER_DATE_SITE AS (
    SELECT 
        SF.ORDER_DATE_DIM_KEY,
        SSD.SITE_STORE,
        ROUND(SUM(QUANTITY), 0) AS QUANTITY,
        ROUND(SUM(SF.SALES_AMOUNT_EXCL_VAT_SEK), 0) AS SALES_AMOUNT_EXCL_VAT_SEK,
        ROUND(SUM(SF.GP1_SEK), 0) AS GP1_SEK,
        ROUND(SUM(SF.GP2_SEK), 0) AS GP2_SEK
    FROM DBT_DATA_VAULT.DM.SALES_FACT SF
    LEFT JOIN DBT_DATA_VAULT.DM.SITE_STORE_DIM SSD ON SF.SHOP_ONLINE_DIM_KEY = SSD."_DV_SITE_STORE_BK" 
    WHERE SF.ORDER_DATE_DIM_KEY = '2024-01-27'
    GROUP BY 1, 2
),
CAMPAIGN_SALES_COMPARED_TO_TOTAL_SALES AS (
    SELECT 
        SF.ORDER_DATE_DIM_KEY,
        SSD.SITE_STORE,
        SF.CAMPAIGN_GROUP,
        TSDS.SALES_AMOUNT_EXCL_VAT_SEK AS TOTAL_SALES_PER_DATE_SITE,
        ROUND(SUM(SF.QUANTITY), 0) AS QUANTITY,
        ROUND(SUM(SF.SALES_AMOUNT_EXCL_VAT_SEK), 0) AS SALES_AMOUNT_EXCL_VAT_SEK,
        ROUND(SUM(SF.GP1_SEK), 0) AS GP1_SEK,
        ROUND(SUM(SF.GP2_SEK), 0) AS GP2_SEK,
        ROUND(SUM(SF.SALES_AMOUNT_EXCL_VAT_SEK) / TSDS.SALES_AMOUNT_EXCL_VAT_SEK, 2) AS SALES_FRACTION_PER_CAMPAIGN_OF_TOTAL_SALES
    FROM DBT_DATA_VAULT.DM.SALES_FACT SF
    LEFT JOIN DBT_DATA_VAULT.DM.SITE_STORE_DIM SSD ON SF.SHOP_ONLINE_DIM_KEY = SSD."_DV_SITE_STORE_BK" 
    LEFT JOIN TOTAL_SALES_PER_DATE_SITE TSDS 
        ON SF.ORDER_DATE_DIM_KEY = TSDS.ORDER_DATE_DIM_KEY
        AND SSD.SITE_STORE = TSDS.SITE_STORE
    WHERE SF.ORDER_DATE_DIM_KEY = '2024-02-22'
    GROUP BY 1, 2, 3, 4
)
SELECT 
    ORDER_DATE_DIM_KEY,
    SITE_STORE,
    COALESCE(CAMPAIGN_GROUP, 'BASELINE') AS CAMPAIGN_GROUP,
    TOTAL_SALES_PER_DATE_SITE,
    QUANTITY,
    SALES_AMOUNT_EXCL_VAT_SEK,
    GP1_SEK,
    GP2_SEK,
    SALES_FRACTION_PER_CAMPAIGN_OF_TOTAL_SALES
FROM CAMPAIGN_SALES_COMPARED_TO_TOTAL_SALES
ORDER BY  3,1, 2;
